<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Virtual - Web</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; background: #f7f7f7; }
    .container { max-width: 720px; margin: 0 auto; background: #fff; padding: 24px; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.06); }
    h1 { margin-top: 0; }
    form { display: flex; gap: 12px; }
    input[type="text"] { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px; }
    button { padding: 12px 16px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; background: #1f6feb; color: #fff; }
    .msg { margin-top: 16px; padding: 12px; border-radius: 8px; }
    .ok { background: #e6ffed; color: #063d1e; border: 1px solid #b7ebc6; }
    .err { background: #fff5f5; color: #611a15; border: 1px solid #f3c1c1; }
    .examples { margin-top: 24px; }
    .examples code { background: #f0f0f0; padding: 2px 6px; border-radius: 6px; }
  </style>
  <link rel="icon" href="data:," />
</head>
<body>
  <div class="container">
    <h1>Assistente Virtual (Web)</h1>
    <form id="cmd-form">
      <input id="cmd-input" type="text" name="text" placeholder="Digite um comando" value="{{ last_text }}" />
      <button type="submit">Executar</button>
      <button type="button" id="mic-btn">üé§ Falar</button>
      <label><input type="checkbox" id="speak-toggle" checked /> Ouvir resposta</label>
    </form>
    <audio id="audio-player" controls style="margin-top:12px; display:none;"></audio>
    <div id="msg" class="msg" style="display:none;"></div>
    <div id="status" class="msg" style="display:none;"></div>
    <div id="spoken" class="msg ok" style="display:none;">Voc√™ disse: <span id="spoken-text"></span></div>
    {% if message is not none %}
      <div class="msg {{ 'ok' if success else 'err' }}">{{ message }}</div>
    {% endif %}
    <div class="examples">
      <p>Exemplos:</p>
      <ul>
        <li><code>wikipedia linguagem python</code></li>
        <li><code>youtube m√∫sica cl√°ssica</code></li>
        <li><code>farm√°cia</code></li>
      </ul>
    </div>
  </div>
  <script>
    const form = document.getElementById('cmd-form');
    const input = document.getElementById('cmd-input');
    const msgBox = document.getElementById('msg');
    const statusBox = document.getElementById('status');
    const spokenBox = document.getElementById('spoken');
    const spokenText = document.getElementById('spoken-text');
    const speakToggle = document.getElementById('speak-toggle');
    const audioPlayer = document.getElementById('audio-player');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      const res = await fetch('/api/execute', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text }) });
      const data = await res.json();
      msgBox.textContent = data.message || '';
      msgBox.className = 'msg ' + (data.success ? 'ok' : 'err');
      msgBox.style.display = 'block';
      if (speakToggle.checked) {
        try {
          if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(data.message || '');
            u.lang = 'pt-BR';
            window.speechSynthesis.speak(u);
          } else {
            const ttsRes = await fetch('/api/tts', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text: data.message || '' }) });
            if (ttsRes.ok) {
              const blob = await ttsRes.blob();
              const url = URL.createObjectURL(blob);
              audioPlayer.src = url;
              audioPlayer.style.display = 'block';
              audioPlayer.play();
            }
          }
        } catch {}
      }
    });
    const micBtn = document.getElementById('mic-btn');
    micBtn.addEventListener('click', () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        statusBox.textContent = 'Reconhecimento de fala n√£o suportado neste navegador. Use Chrome (Windows).';
        statusBox.className = 'msg err';
        statusBox.style.display = 'block';
        return;
      }
      const rec = new SR();
      rec.lang = 'pt-BR';
      rec.interimResults = true;
      rec.maxAlternatives = 1;
      rec.onstart = () => {
        statusBox.textContent = 'Ouvindo...';
        statusBox.className = 'msg ok';
        statusBox.style.display = 'block';
        spokenText.textContent = '';
        spokenBox.style.display = 'none';
      };
      rec.onresult = (e) => {
        const t = Array.from(e.results).map(r => r[0].transcript).join(' ').trim();
        spokenText.textContent = t;
        spokenBox.style.display = t ? 'block' : 'none';
        const last = e.results[e.results.length - 1];
        if (last && last.isFinal) {
          input.value = t;
          form.dispatchEvent(new Event('submit'));
        }
      };
      rec.onerror = (ev) => {
        statusBox.textContent = 'Erro no microfone: ' + (ev.error || 'desconhecido');
        statusBox.className = 'msg err';
        statusBox.style.display = 'block';
        // Sem fallback servidor-side neste ambiente; ver instru√ß√µes abaixo
      };
      rec.onend = () => {
        if (statusBox.textContent === 'Ouvindo...') {
          statusBox.textContent = 'N√£o foi poss√≠vel captar fala';
          statusBox.className = 'msg err';
          statusBox.style.display = 'block';
        }
      };
      rec.start();
    });

  </script>
</body>
</html>